var DbNetSuiteCore={},controlArray={};DbNetSuiteCore.controlArray=controlArray;DbNetSuiteCore.createClientControl=function(n,t){document.addEventListener("htmx:afterRequest",function(i){if(!DbNetSuiteCore.controlArray[n]){var r={};n.startsWith("Grid")&&(r=new GridControl(n));n.startsWith("Select")&&(r=new SelectControl(n));for(const[n,i]of Object.entries(t))r.eventHandlers[n]=window[i.toString()];DbNetSuiteCore.controlArray[n]=r}DbNetSuiteCore.controlArray[n].afterRequest(i)})};class ComponentControl{constructor(n){this.controlId="";this.childControls={};this.eventHandlers={};this.isElementLoaded=async n=>{while(document.querySelector(n)===null)await new Promise(n=>requestAnimationFrame(n));return document.querySelector(n)};this.controlId=n;this.formControl=document.querySelector(this.formSelector());this.formControl.style.display="";this.controlContainer=this.formControl.parentElement}invokeEventHandler(n,t={}){(window.dispatchEvent(new CustomEvent(`Grid${n}`,{detail:this.controlId})),this.eventHandlers.hasOwnProperty(n)!=!1)&&(typeof this.eventHandlers[n]=="function"?this.eventHandlers[n](this,t):this.message(`Javascript function for event type '${n}' is not defined`,"error",3))}message(n,t="info",i=1){var r=this.controlContainer.querySelector("#toastMessage");if(r.querySelector("span").innerText=n,n==""){r.parentElement.style.marginLeft=`-${r.parentElement.clientWidth/2}px`;r.parentElement.style.marginTop=`-${r.parentElement.clientHeight/2}px`;r.parentElement.style.display="none";return}r.parentElement.style.display="block";let u=this;window.setTimeout(()=>{u.message("")},i*1e3)}formSelector(){return`#${this.controlId}`}controlElements(n){return this.formControl.querySelectorAll(n)}controlElement(n){return this.formControl.querySelector(n)}triggerName(n){var t;return((t=n.detail.requestConfig.headers["HX-Trigger-Name"])!==null&&t!==void 0?t:"").toLowerCase()}updateLinkedControls(n,t,i=null){var r=n.split(",");r.forEach(n=>{this.isElementLoaded(`#${n}`).then(()=>{var r=DbNetSuiteCore.controlArray[n];r.parentControl=this;this.childControls[n]=r;i!=null&&r.dataSourceIsFileSystem()&&(t=i);r.loadFromParent(t)})})}dataSourceIsFileSystem(){return this.formControl.dataset.datasourcetype=="FileSystem"}loadFromParent(n){let t=`#${this.controlId} input[name="primaryKey"]`,i=htmx.find(t);this.formControl.setAttribute("hx-vals",JSON.stringify({primaryKey:n}));i?htmx.trigger(t,"changed"):htmx.trigger(`#${this.controlId}`,"submit")}}class GridControl extends ComponentControl{constructor(n){super(n);this.bgColourClass="bg-cyan-600";this.textColourClass="text-zinc-100"}afterRequest(n){let r=n.target.closest("form").id;if(r.startsWith(this.controlId)!=!1&&n.detail.elt.name!="nestedGrid"){if(this.triggerName(n)=="viewdialogcontent"){this.viewDialog.show();this.invokeEventHandler("ViewDialogUpdated",{viewDialog:this.viewDialog});return}if(this.controlElement("tbody")){this.configureNavigation();this.configureSortIcon();this.triggerName(n)=="initialload"&&this.initialise();this.controlElements(".nested-icons").forEach(n=>{let t=n.querySelectorAll("span");t[0].addEventListener("click",n=>this.showHideNestedGrid(n,!0));t[1].addEventListener("click",n=>this.showHideNestedGrid(n,!1))});this.controlElements("tr.grid-row").forEach(n=>{this.invokeEventHandler("RowTransform",{row:n})});this.controlElements("td[data-value]").forEach(n=>{this.invokeCellTransform(n)});this.controlElements("tbody a").forEach(n=>{n.classList.remove("selected"),n.classList.add("underline")});this.rowSelection()!="none"&&(this.controlElement(this.multiRowSelectAllSelector())?(this.controlElement(this.multiRowSelectAllSelector()).addEventListener("change",n=>{this.updateMultiRowSelect(n)}),this.controlElements(this.multiRowSelectSelector()).forEach(n=>{n.addEventListener("change",n=>{this.selectRow(n.target,!0)})})):htmx.findAll(this.rowSelector()).forEach(n=>{n.addEventListener("click",n=>this.selectRow(n.target))}));let i=document.querySelector(this.rowSelector());i&&i.click();this.controlElements("tr.column-filter-refresh select").forEach(n=>{let t=this.controlElement(`thead select[data-key="${n.dataset.key}"]`);t&&(t.innerHTML=n.innerHTML)});this.controlElements("thead input[data-key]").forEach(n=>{n.title="",n.style.backgroundColor=""});this.controlElements("tr.column-filter-error span").forEach(n=>{let t=this.controlElement(`thead input[data-key="${n.dataset.key}"]`);t.title=n.innerText;t.style.backgroundColor="rgb(252 165 165)"});let t=this.controlElement("thead");t.dataset.frozen.toLowerCase()=="true"&&(t.style.top=`0px`,t.style.position="sticky",t.style.zIndex="1");this.invokeEventHandler("PageLoaded")}}}initialise(){this.toolbarExists()&&(this.getButton("copy").addEventListener("click",()=>this.copyTableToClipboard()),this.getButton("export").addEventListener("click",()=>this.download()));var n=this.controlElement(".view-dialog");n&&(this.viewDialog=new ViewDialog(n,this));this.invokeEventHandler("Initialised")}invokeCellTransform(n){var t=this.controlElement("thead").children[0].children[n.cellIndex].dataset.columnname,i={cell:n,columnName:t};this.invokeEventHandler("CellTransform",i)}configureNavigation(){let r=this.controlElement("tbody"),t=parseInt(r.dataset.currentpage),n=parseInt(r.dataset.totalpages),i=parseInt(r.dataset.rowcount);if(n==0&&this.updateLinkedGrids(""),this.viewDialog&&(this.getButton("view").disabled=i==0,i==0&&this.viewDialog.close()),this.toolbarExists()){let r=parseInt(this.controlElement("#query-limited").dataset.querylimit);n==0?(this.removeClass("#no-records","hidden"),this.addClass("#navigation","hidden")):(this.addClass("#no-records","hidden"),this.removeClass("#navigation","hidden"));r>0&&r==i?this.removeClass("#query-limited","hidden"):this.addClass("#query-limited","hidden");this.setPageNumber(t,n);this.controlElement('[data-type="total-pages"]').value=n.toString();this.controlElement('[data-type="row-count"]').value=i.toString();this.getButton("first").disabled=t==1;this.getButton("previous").disabled=t==1;this.getButton("next").disabled=t==n;this.getButton("last").disabled=t==n}}rowSelection(){let n=this.controlElement("thead");return n.dataset.rowselection.toLowerCase()}removeClass(n,t){this.controlElement(n).classList.remove(t)}addClass(n,t){this.controlElement(n).classList.add(t)}setPageNumber(n,t){var r=this.controlElement('[name="page"]'),i,u;if(r.childElementCount!=t)for(r.querySelectorAll("option").forEach(n=>n.remove()),i=1;i<=t;i++)u=document.createElement("option"),u.value=i.toString(),u.text=i.toString(),r.appendChild(u);r.value=n.toString()}toolbarExists(){return this.controlElement("#navigation")}configureSortIcon(){if(this.controlElements(`th[data-key]`).length!=0){let t=this.controlElement("tbody"),i=t.dataset.sortkey,r=t.querySelector("span#sortIcon").innerHTML;this.controlElements(`th[data-key] span`).forEach(n=>n.innerHTML="");let n=this.controlElement(`th[data-key="${i}"] span`);n||(n=this.controlElements(`th[data-key] span`)[0]);n.innerHTML=r}}showHideNestedGrid(n,t){n.stopPropagation();let u=n.target.closest("tr"),i=u.firstElementChild.querySelectorAll("span"),r=u.nextElementSibling;r&&r.classList.contains("nested-grid-row")?r.style.display=t?null:"none":t&&htmx.trigger(i[2],"click");i[0].style.display=t?"none":"block";i[1].style.display=t?"block":"none"}refresh(){let n=this.controlElement('[name="page"]');n.value="1";htmx.trigger(n,"changed")}updateMultiRowSelect(n){let t=n.target.checked;this.controlElements(this.multiRowSelectSelector()).forEach(n=>{n.checked=t,this.selectRow(n)});this.selectedValuesChanged()}selectRow(n,t=false){let i=n.closest("tr");if(n.classList.contains("multi-select")==!1){if(i.classList.contains(this.bgColourClass))return;this.clearHighlighting(null)}else if(n.checked==!1){this.clearHighlighting(i);t&&this.selectedValuesChanged();return}i.classList.add(this.bgColourClass,this.textColourClass);i.querySelectorAll("a").forEach(n=>n.classList.add("selected"));i.querySelectorAll("td[data-value] > div > svg,td[data-isfolder] svg,td > div.nested-icons svg").forEach(n=>n.setAttribute("fill","#ffffff"));this.updateLinkedGrids(i.dataset.id);this.selectedRow=i;this.viewDialog&&(this.viewDialog.configureNavigation(i),this.viewDialog.update());this.invokeEventHandler("RowSelected",{selectedRow:i});t&&this.selectedValuesChanged()}selectedValuesChanged(){this.invokeEventHandler("SelectedRowsUpdated",{selectedValues:this.selectedValues()})}updateLinkedGrids(n){let t=this.controlElement("table");t.dataset.linkedgridids&&this.updateLinkedControls(t.dataset.linkedgridids,n)}clearHighlighting(n){n?this.clearRowHighlight(n):this.controlElements(this.rowSelector()).forEach(n=>{this.clearRowHighlight(n.closest("tr"))})}clearRowHighlight(n){n.classList.remove(this.bgColourClass,this.textColourClass);n.querySelectorAll("a").forEach(n=>n.classList.remove("selected"));n.querySelectorAll("td[data-value] > div > svg,td[data-isfolder] svg,td > div.nested-icons svg").forEach(n=>n.setAttribute("fill","#666666"))}copyTableToClipboard(){var n=this.controlElement("table");try{this.copyElementToClipboard(n);this.message("Page copied to clipboard")}catch(t){try{const t=n.innerHTML,i=new Blob([t],{type:"text/html"}),r=new ClipboardItem({"text/html":i});navigator.clipboard.write([r]);this.message("Page copied to clipboard")}catch(t){this.message("Copy failed","error",5);return}}}copyElementToClipboard(n){window.getSelection().removeAllRanges();let t=document.createRange();t.selectNode(typeof n=="string"?document.getElementById(n):n);window.getSelection().addRange(t);document.execCommand("copy");window.getSelection().removeAllRanges()}previousRow(){this.selectedRow.previousElementSibling.click()}nextRow(){this.selectedRow.nextElementSibling.click()}download(){this.showIndicator();const n=new URLSearchParams;for(let[t,i]of new FormData(this.formControl))n.append(t,i);var t=this.controlElement('[name="exportformat"]').value;fetch("gridcontrol.htmx",{method:"post",body:n,headers:{"hx-trigger-name":"download"}}).then(n=>{if(this.hideIndicator(),n.headers.has("error"))throw new Error(n.headers.get("error"));else return n.blob()}).then(n=>{n&&(t=="html"?this.openWindow(n):this.downloadFile(n,t))}).catch(n=>console.log(`Critical failure: ${n.message}`))}openWindow(n){const t=window.URL.createObjectURL(n),i=window.open();i.location.href=t}downloadFile(n,t){const i=document.createElement("a");i.href=window.URL.createObjectURL(n);t=t=="excel"?"xlsx":t;i.download=`report_${(new Date).getTime()}.${t}`;this.invokeEventHandler("FileDownload",{link:i,extension:t});i.click()}showIndicator(){this.indicator().classList.add("htmx-request")}hideIndicator(){this.indicator().classList.remove("htmx-request")}indicator(){return this.controlContainer.children[1]}rowSelector(){return`#tbody${this.controlId} > tr.grid-row`}multiRowSelectAllSelector(){return`th > input.multi-select`}multiRowSelectSelector(){return`td > input.multi-select`}buttonSelector(n){return`button[button-type="${n}"]`}getButton(n){return this.controlElement(this.buttonSelector(n))}gridControlElement(n){return this.controlElement(n)}selectedValues(){let n=[];return this.controlElements(this.multiRowSelectSelector()).forEach(t=>{if(t.checked){let i=t.closest("tr");i.dataset.id&&n.push(i.dataset.id)}}),n}columnCells(n){let t=this.heading(n);return this.controlElements(`td:nth-child(${t.cellIndex+1})`)}heading(n){return this.controlElement(`th[data-columnname='${n.toLowerCase()}']`)}columnCell(n,t){let i=this.heading(n);return i?t.querySelector(`td:nth-child(${i.cellIndex+1})`):null}columnValue(n,t){t||(t=this.selectedRow);let i=t.dataset[n.toLowerCase()];if(i)return i;let r=this.columnCell(n,t);return r?r.dataset.value:null}setCaption(n){var t=this.controlElement("div.caption");t&&(t.innerText=n)}}class SelectControl extends ComponentControl{constructor(n){super(n)}afterRequest(n){let i=n.target.closest("form").id;if(i.startsWith(this.controlId)!=!1){this.select=this.controlElement("select");let t=this.controlElements("select");this.select.innerHTML=t[1].innerHTML;t[1].remove();this.triggerName(n)=="initialload"&&this.initialise();this.invokeEventHandler("OptionsLoaded");this.selectChanged(this.select);this.checkForError()}}initialise(){this.controlElement("select").addEventListener("change",n=>{this.selectChanged(n.target)});this.invokeEventHandler("Initialised")}selectChanged(n){let i="";if(n.selectedOptions.length){var t=n.selectedOptions[0].dataset;i=this.dataSourceIsFileSystem()&&t.isdirectory&&t.isdirectory.toLowerCase()=="true"?t.path:""}this.updateLinkedSelects(n.value,i);this.invokeEventHandler("OptionSelected",{selectedOptions:n.selectedOptions})}updateLinkedSelects(n,t){this.select.dataset.linkedcontrolids&&this.updateLinkedControls(this.select.dataset.linkedcontrolids,n,t)}checkForError(){var n=this.controlElement("select");const t=n.querySelector("div");t&&n.parentElement.nextElementSibling.after(t)}}class DraggableDialog{constructor(n,t="dialog-header",i){if(this.isDragging=!1,this.initialX=0,this.initialY=0,this.xOffset=0,this.yOffset=0,this.dialog=document.getElementById(n),this.container=i,!this.dialog)throw new Error(`Dialog with id "${n}" not found`);if(this.dragHandle=this.dialog.querySelector(`.${t}`),!this.dragHandle)throw new Error(`Drag handle with class "${t}" not found in the dialog`);this.initDragEvents()}initDragEvents(){this.dragHandle.addEventListener("mousedown",this.startDragging.bind(this));document.addEventListener("mousemove",this.drag.bind(this));document.addEventListener("mouseup",this.stopDragging.bind(this));this.xOffset=0-this.container.clientWidth/2+this.container.offsetLeft;this.yOffset=0-this.container.clientHeight/2+this.container.offsetTop;this.setTranslate(this.xOffset,this.yOffset)}startDragging(n){n.target.closest(`.${this.dragHandle.className}`)===this.dragHandle&&(this.isDragging=!0,this.initialX=n.clientX-(this.xOffset?this.xOffset:this.dialog.clientWidth/-2),this.initialY=n.clientY-(this.yOffset?this.yOffset:this.dialog.clientHeight/-2),this.dragHandle.style.cursor="move",document.body.style.userSelect="none")}drag(n){this.isDragging&&(n.preventDefault(),this.xOffset=n.clientX-this.initialX,this.yOffset=n.clientY-this.initialY,this.setTranslate(this.xOffset,this.yOffset))}stopDragging(){this.isDragging=!1;this.dragHandle.style.cursor="";document.body.style.userSelect="";document.removeEventListener("mousemove",this.drag);document.removeEventListener("mouseup",this.stopDragging)}setTranslate(n,t){requestAnimationFrame(()=>{this.dialog.style.transform=`translate3d(${n}px, ${t}px, 0)`})}}class ViewDialog{constructor(n,t){this.draggableDialog=null;this.dialog=n;this.gridControl=t;let i=this.dialog.querySelectorAll(this.gridControl.buttonSelector("close"));i.forEach(n=>{n.addEventListener("click",()=>this.dialog.close())});this.dialog.querySelector(this.gridControl.buttonSelector("previous")).addEventListener("click",()=>this.gridControl.previousRow());this.dialog.querySelector(this.gridControl.buttonSelector("next")).addEventListener("click",()=>this.gridControl.nextRow());this.gridControl.getButton("view").addEventListener("click",this.open.bind(this))}open(){this.getRecord()}show(){this.dialog.show();this.draggableDialog||(this.draggableDialog=new DraggableDialog(this.dialog.id,"dialog-nav",this.gridControl.gridControlElement("tbody")))}update(){this.dialog&&this.dialog.open&&this.getRecord()}getRecord(){let n=this.dialog.querySelector("input[hx-post]");n.value=this.gridControl.selectedRow.dataset.id;htmx.trigger(n,"changed")}close(){this.dialog&&this.dialog.open&&this.close()}configureNavigation(n){this.configureButton(n.previousElementSibling,"previous");this.configureButton(n.nextElementSibling,"next")}configureButton(n,t){this.dialog.querySelector(this.gridControl.buttonSelector(t)).disabled=!n||n.classList.contains("grid-row")==!1}columnCell(n){return this.dialog.querySelector(`div[data-columnname='${n.toLowerCase()}']`)}columnValue(n){let t=this.columnCell(n);return t?t.dataset.value:null}}