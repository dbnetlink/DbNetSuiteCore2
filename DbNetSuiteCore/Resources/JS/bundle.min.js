var DbNetSuiteCore={},controlArray={};DbNetSuiteCore.controlArray=controlArray;DbNetSuiteCore.createClientControl=function(n,t){document.addEventListener("htmx:afterRequest",function(i){if(!DbNetSuiteCore.controlArray[n]){var r={};n.startsWith("Grid")&&(r=new GridControl(n));n.startsWith("Select")&&(r=new SelectControl(n));n.startsWith("Form")&&(r=new FormControl(n));for(const[n,i]of Object.entries(t))r.eventHandlers[n]=window[i.toString()];DbNetSuiteCore.controlArray[n]=r}DbNetSuiteCore.controlArray[n].afterRequest(i)})};class ComponentControl{constructor(n){this.controlId="";this.childControls={};this.eventHandlers={};this.isElementLoaded=async n=>{while(document.querySelector(n)===null)await new Promise(n=>requestAnimationFrame(n));return document.querySelector(n)};this.controlId=n;this.form=document.querySelector(this.formSelector());this.form.style.display="";this.controlContainer=this.form.parentElement}setCaption(n){var t=this.controlElement("div.caption");t&&(t.innerText=n)}invokeEventHandler(n,t={}){return this.eventHandlers.hasOwnProperty(n)==!1?!1:(typeof this.eventHandlers[n]=="function"?this.eventHandlers[n](this,t):this.toast(`Javascript function for event type '${n}' is not defined`,"error",3),!0)}eventHandlerAttached(n){return typeof this.eventHandlers[n]=="function"}toast(n,t="info",i=1){var r=this.controlContainer.querySelector("#toastMessage");if(r.querySelector("span").innerText=n,n==""){r.parentElement.style.marginLeft=`-${r.parentElement.clientWidth/2}px`;r.parentElement.style.marginTop=`-${r.parentElement.clientHeight/2}px`;r.parentElement.style.display="none";return}r.parentElement.style.display="block";let u=this;window.setTimeout(()=>{u.toast("")},i*1e3)}formSelector(){return`#${this.controlId}`}controlElements(n){return this.form.querySelectorAll(n)}controlElement(n){return this.form.querySelector(n)}triggerName(n){let t=n.detail.headers?n.detail.headers:n.detail.requestConfig.headers;return t["HX-Trigger-Name"]?t["HX-Trigger-Name"].toLowerCase():""}triggerElement(n){return n.detail.requestConfig.elt}updateLinkedControls(n,t,i=null){var r=n.split(",");r.forEach(n=>{this.isElementLoaded(`#${n}`).then(()=>{var r=DbNetSuiteCore.controlArray[n];r.parentControl=this;this.childControls[n]=r;i!=null&&r.dataSourceIsFileSystem()&&(t=i);r.loadFromParent(t)})})}notifyParent(n){this.parentControl&&this.parentControl.childLoaded(n)}childLoaded(n){if(this instanceof FormControl){let t=this.getButton("delete");t&&(t.disabled=n)}}dataSourceIsFileSystem(){return this.form.dataset.datasourcetype=="FileSystem"}loadFromParent(n){let t=`#${this.controlId} input[name="primaryKey"]`,i=htmx.find(t);this.form.setAttribute("hx-vals",JSON.stringify({primaryKey:n}));i?htmx.trigger(t,"changed"):htmx.trigger(`#${this.controlId}`,"submit")}toolbarExists(){return this.controlElement("#navigation")}removeClass(n,t){let i=this.controlElement(n);i&&i.classList.remove(t)}addClass(n,t){let i=this.controlElement(n);i&&i.classList.add(t)}getButton(n){return this.controlElement(this.buttonSelector(n))}buttonSelector(n){return`button[button-type="${n}"]`}setPageNumber(n,t,i){var u=this.controlElement(`[name="${i}"]`),r,f;if(u.childElementCount!=t)for(u.querySelectorAll("option").forEach(n=>n.remove()),r=1;r<=t;r++)f=document.createElement("option"),f.value=r.toString(),f.text=r.toString(),u.appendChild(f);u.value=n.toString()}isControlEvent(n){let t=n.target.closest("form").id;return t.startsWith(this.controlId)}}class GridControl extends ComponentControl{constructor(n){super(n);this.bgColourClass="bg-cyan-600";this.textColourClass="text-zinc-100"}afterRequest(n){let f=n.target.closest("form").id;if(f.startsWith(this.controlId)!=!1&&n.detail.elt.name!="nestedGrid"){let i=null;switch(this.triggerName(n)){case"viewdialogcontent":this.viewDialog.show();this.invokeEventHandler("ViewDialogUpdated",{viewDialog:this.viewDialog});return;case"refresh":let t=JSON.parse(this.triggerElement(n).getAttribute("hx-vals"));i=t.rowIndex}if(this.controlElement("tbody")){this.configureNavigation();this.configureSortIcon();this.triggerName(n)=="initialload"&&this.initialise();this.controlElements(".nested-icons").forEach(n=>{let t=n.querySelectorAll("span");t[0].addEventListener("click",n=>this.showHideNestedGrid(n,!0));t[1].addEventListener("click",n=>this.showHideNestedGrid(n,!1))});this.controlElements("tr.grid-row").forEach(n=>{this.invokeEventHandler("RowTransform",{row:n})});this.controlElements("td[data-value]").forEach(n=>{this.invokeCellTransform(n)});this.controlElements("tbody a").forEach(n=>{n.classList.remove("selected"),n.classList.add("underline")});this.rowSelection()!="none"&&(this.controlElement(this.multiRowSelectAllSelector())?(this.controlElement(this.multiRowSelectAllSelector()).addEventListener("change",n=>{this.updateMultiRowSelect(n)}),this.controlElements(this.multiRowSelectSelector()).forEach(n=>{n.addEventListener("change",n=>{this.selectRow(n.target,!0)})})):htmx.findAll(this.rowSelector()).forEach(n=>{n.addEventListener("click",n=>this.selectRow(n.target))}));let r=document.querySelector(this.rowSelector(i>-1?i:null));r&&r.click();this.controlElements("tr.column-filter-refresh select").forEach(n=>{let t=this.controlElement(`thead select[data-key="${n.dataset.key}"]`);t&&(t.innerHTML=n.innerHTML)});this.controlElements("thead input[data-key]").forEach(n=>{n.title="",n.style.backgroundColor=""});this.controlElements("tr.column-filter-error span").forEach(n=>{let t=this.controlElement(`thead input[data-key="${n.dataset.key}"]`);t.title=n.innerText;t.style.backgroundColor="rgb(252 165 165)"});let t=this.controlElement("thead");t.dataset.frozen.toLowerCase()=="true"&&(t.style.top=`0px`,t.style.position="sticky",t.style.zIndex="1");var u={};this.gridControlElement("#jsonData")&&(this.jsonData=JSON.parse(this.gridControlElement("#jsonData").value),u.json=this.jsonData);this.invokeEventHandler("PageLoaded",u)}}}initialise(){var n,t;this.toolbarExists()&&(this.getButton("copy").addEventListener("click",()=>this.copyTableToClipboard()),this.getButton("export").addEventListener("click",()=>this.download()));n=this.controlElement(".view-dialog");n&&(this.viewDialog=new ViewDialog(n,this));t=this.controlElement(".search-dialog");t&&this.getButton("search")&&(this.searchDialog=new SearchDialog(t,this));document.body.addEventListener("htmx:beforeRequest",n=>{this.beforeRequest(n)});this.invokeEventHandler("Initialised")}beforeRequest(n){if(this.isControlEvent(n)!=!1)switch(this.triggerName(n)){case"searchdialog":if(this.form.checkValidity()==!1){this.form.reportValidity();n.preventDefault();return}}}columnSeriesData(n){let i=[];if(this.jsonData.length){let r=this.getPropertyName(this.jsonData[0],n);if(r)for(var t=0;t<this.jsonData.length;t++)i.push(this.jsonData[t][r])}return i}getPropertyName(n,t){let i=null;for(var r in n)if(r.toLowerCase()==t.toLowerCase()){i=r;break}return i}rowSeriesData(n,t,i){let r=[];if(this.jsonData.length){let u=this.columnSeriesData(n);for(let n=0;n<u.length;n++)if(u[n]==t)for(let t=0;t<i.length;t++){let u=this.getPropertyName(this.jsonData[n],i[t]);u&&r.push(this.jsonData[n][u])}}return r}refreshPage(){let n=`#${this.controlId} input[name="refresh"]`,i=htmx.find(n),t=this.selectedRow?this.selectedRow.rowIndex:1;this.form.setAttribute("hx-vals",JSON.stringify({rowIndex:t}));i.setAttribute("hx-vals",JSON.stringify({rowIndex:t}));htmx.trigger(n,"changed")}invokeCellTransform(n){var t=this.controlElement("thead").children[0].children[n.cellIndex].dataset.columnname,i={cell:n,columnName:t};this.invokeEventHandler("CellTransform",i)}configureNavigation(){let r=this.controlElement("tbody"),t=parseInt(r.dataset.currentpage),n=parseInt(r.dataset.totalpages),i=parseInt(r.dataset.rowcount);if(n==0&&this.updateLinkedGrids(""),this.notifyParent(i>0),this.viewDialog&&(this.getButton("view").disabled=i==0,i==0&&this.viewDialog.close()),this.toolbarExists()){let r=parseInt(this.controlElement("#query-limited").dataset.querylimit);n==0?(this.removeClass("#no-records","hidden"),this.addClass("#navigation","hidden")):(this.addClass("#no-records","hidden"),this.removeClass("#navigation","hidden"));r>0&&r==i?this.removeClass("#query-limited","hidden"):this.addClass("#query-limited","hidden");this.setPageNumber(t,n,"page");this.controlElement('[data-type="total-pages"]').value=n.toString();this.controlElement('[data-type="row-count"]').value=i.toString();this.getButton("first").disabled=t==1;this.getButton("previous").disabled=t==1;this.getButton("next").disabled=t==n;this.getButton("last").disabled=t==n}}rowSelection(){let n=this.controlElement("thead");return n.dataset.rowselection.toLowerCase()}configureSortIcon(){if(this.controlElements(`th[data-key]`).length!=0){let t=this.controlElement("tbody"),i=t.dataset.sortkey,r=t.querySelector("span#sortIcon").innerHTML;this.controlElements(`th[data-key] span`).forEach(n=>n.innerHTML="");let n=this.controlElement(`th[data-key="${i}"] span`);n||(n=this.controlElements(`th[data-key] span`)[0]);n.innerHTML=r}}showHideNestedGrid(n,t){n.stopPropagation();let u=n.target.closest("tr"),i=u.firstElementChild.querySelectorAll("span"),r=u.nextElementSibling;r&&r.classList.contains("nested-grid-row")?r.style.display=t?null:"none":t&&htmx.trigger(i[2],"click");i[0].style.display=t?"none":"block";i[1].style.display=t?"block":"none"}refresh(){let n=this.controlElement('[name="page"]');n.value="1";htmx.trigger(n,"changed")}updateMultiRowSelect(n){let t=n.target.checked;this.controlElements(this.multiRowSelectSelector()).forEach(n=>{n.checked=t,this.selectRow(n)});this.selectedValuesChanged()}selectRow(n,t=false){let i=n.closest("tr");if(n.classList.contains("multi-select")==!1){if(i.classList.contains(this.bgColourClass))return;this.clearHighlighting(null)}else if(n.checked==!1){this.clearHighlighting(i);t&&this.selectedValuesChanged();return}i.classList.add(this.bgColourClass,this.textColourClass);i.querySelectorAll("a").forEach(n=>n.classList.add("selected"));i.querySelectorAll("td[data-value] > div > svg,td[data-isfolder] svg,td > div.nested-icons svg").forEach(n=>n.setAttribute("fill","#ffffff"));this.updateLinkedGrids(i.dataset.id);this.selectedRow=i;this.viewDialog&&(this.viewDialog.configureNavigation(i),this.viewDialog.update());this.invokeEventHandler("RowSelected",{selectedRow:i});t&&this.selectedValuesChanged()}selectedValuesChanged(){this.invokeEventHandler("SelectedRowsUpdated",{selectedValues:this.selectedValues()})}updateLinkedGrids(n){let t=this.controlElement("table");t.dataset.linkedcontrolids&&this.updateLinkedControls(t.dataset.linkedcontrolids,n)}clearHighlighting(n){n?this.clearRowHighlight(n):this.controlElements(this.rowSelector()).forEach(n=>{this.clearRowHighlight(n.closest("tr"))})}clearRowHighlight(n){n.classList.remove(this.bgColourClass,this.textColourClass);n.querySelectorAll("a").forEach(n=>n.classList.remove("selected"));n.querySelectorAll("td[data-value] > div > svg,td[data-isfolder] svg,td > div.nested-icons svg").forEach(n=>n.setAttribute("fill","#666666"))}copyTableToClipboard(){var n=this.controlElement("table");try{this.copyElementToClipboard(n);this.toast("Page copied to clipboard")}catch(t){try{const t=n.innerHTML,i=new Blob([t],{type:"text/html"}),r=new ClipboardItem({"text/html":i});navigator.clipboard.write([r]);this.toast("Page copied to clipboard")}catch(t){this.toast("Copy failed","error",5);return}}}copyElementToClipboard(n){window.getSelection().removeAllRanges();let t=document.createRange();t.selectNode(typeof n=="string"?document.getElementById(n):n);window.getSelection().addRange(t);document.execCommand("copy");window.getSelection().removeAllRanges()}previousRow(){this.selectedRow.previousElementSibling.click()}nextRow(){this.selectedRow.nextElementSibling.click()}download(){this.showIndicator();const n=new URLSearchParams;for(let[t,i]of new FormData(this.form))n.append(t,i);var t=this.controlElement('[name="exportformat"]').value;fetch("gridcontrol.htmx",{method:"post",body:n,headers:{"hx-trigger-name":"download"}}).then(n=>{if(this.hideIndicator(),n.headers.has("error"))throw new Error(n.headers.get("error"));else return n.blob()}).then(n=>{n&&(t=="html"?this.openWindow(n):this.downloadFile(n,t))}).catch(n=>console.log(`Critical failure: ${n.message}`))}openWindow(n){const t=window.URL.createObjectURL(n),i=window.open();i.location.href=t}downloadFile(n,t){const i=document.createElement("a");i.href=window.URL.createObjectURL(n);t=t=="excel"?"xlsx":t;i.download=`report_${(new Date).getTime()}.${t}`;this.invokeEventHandler("FileDownload",{link:i,extension:t});i.click()}showIndicator(){this.indicator().classList.add("htmx-request")}hideIndicator(){this.indicator().classList.remove("htmx-request")}indicator(){return this.controlContainer.children[1]}rowSelector(n=null){var t=n?`tr:nth-child(${n})`:"tr.grid-row";return`#tbody${this.controlId} > ${t}`}multiRowSelectAllSelector(){return`th > input.multi-select`}multiRowSelectSelector(){return`td > input.multi-select`}gridControlElement(n){return this.controlElement(n)}selectedValues(){let n=[];return this.controlElements(this.multiRowSelectSelector()).forEach(t=>{if(t.checked){let i=t.closest("tr");i.dataset.id&&n.push(i.dataset.id)}}),n}columnCells(n){let t=this.heading(n);return this.controlElements(`td:nth-child(${t.cellIndex+1})`)}heading(n){return this.controlElement(`th[data-columnname='${n.toLowerCase()}']`)}columnCell(n,t){let i=this.heading(n);return i?t.querySelector(`td:nth-child(${i.cellIndex+1})`):null}columnValue(n,t){t||(t=this.selectedRow);let i=t.dataset[n.toLowerCase()];if(i)return i;let r=this.columnCell(n,t);return r?r.dataset.value:null}}class SelectControl extends ComponentControl{constructor(n){super(n)}afterRequest(n){let i=n.target.closest("form").id;if(i.startsWith(this.controlId)!=!1){this.select=this.controlElement("select");let t=this.controlElements("select");this.select.innerHTML=t[1].innerHTML;t[1].remove();this.triggerName(n)=="initialload"&&this.initialise();this.invokeEventHandler("OptionsLoaded");this.selectChanged(this.select);this.checkForError()}}initialise(){this.controlElement("select").addEventListener("change",n=>{this.selectChanged(n.target)});this.invokeEventHandler("Initialised")}selectChanged(n){let i="";if(n.selectedOptions.length){var t=n.selectedOptions[0].dataset;i=this.dataSourceIsFileSystem()&&t.isdirectory&&t.isdirectory.toLowerCase()=="true"?t.path:""}this.updateLinkedChildControls(n.value,i);this.invokeEventHandler("OptionSelected",{selectedOptions:n.selectedOptions})}updateLinkedChildControls(n,t){this.select.dataset.linkedcontrolids&&this.updateLinkedControls(this.select.dataset.linkedcontrolids,n,t)}checkForError(){var n=this.controlElement("select");const t=n.querySelector("div");t&&n.parentElement.nextElementSibling.after(t)}}class FormControl extends ComponentControl{constructor(n){super(n);this.htmlEditorArray={};this.htmlEditorMissing=!1}afterRequest(n){if(this.isControlEvent(n)==!1)return!1;if(this.triggerName(n)!="toolbar"&&(this.formContainer=this.controlElement("div.form-container"),this.formBody=this.controlElement("div.form-body"),this.formMessage=this.controlElement("#form-message"),this.formBody)){this.notifyParent(this.formMode()=="update");switch(this.triggerName(n)){case"initialload":this.initialise();break;default:this.htmlEditorMissing==!1&&this.htmlEditorElements().forEach(n=>{this.htmlEditorArray[n.id].reset(n)})}this.cachedMessage&&this.setMessage(this.cachedMessage);this.updateLinkedChildControls(this.formBody.dataset.id);window.setTimeout(()=>{this.clearErrorMessage()},3e3);this.controlElements("select.fc-control.readonly").forEach(n=>{this.makeSelectReadonly(n)});this.controlElements("input.fc-control.readonly").forEach(n=>{this.makeCheckboxReadonly(n)});this.controlElements("input[data-texttransform]").forEach(n=>{this.transformText(n)});this.configureHtmlEditors();this.setFocus();this.invokeEventHandler("RecordLoaded")}}formMode(){return this.formBody.dataset.mode.toLowerCase()}afterSettle(n){if(this.isControlEvent(n)==!1)return!1;if(this.formBody){this.cachedMessage=null;switch(this.triggerName(n)){case"apply":this.formBody.dataset.validationpassed=="True"&&this.validateUpdate();this.formBody.dataset.committype&&this.refreshParent();break;case"delete":this.refreshParent()}}}refreshParent(){this.parentControl&&this.parentControl instanceof GridControl&&(this.cachedMessage=this.formMessage.innerText,this.parentControl.refreshPage())}triggerCommit(){let n=this.getButton("apply");htmx.trigger(n,"click")}validateUpdate(){let n={mode:this.formBody.dataset.mode,message:""};this.invokeEventHandler("ValidateUpdate",n);var t=Boolean(n.message!=""||this.errorHighlighted());this.controlElement("input[name='validationPassed']").value=(t==!1).toString();t?this.setMessage(n.message!=""?n.message:"Highlighted fields are in error","error"):this.triggerCommit()}validateDelete(){let n={message:""};if(this.invokeEventHandler("ValidateDelete",n)==!1)return!0;var t=Boolean(n.message!=""||this.errorHighlighted());return t?(this.setMessage(n.message!=""?n.message:"Deletion not allowed","error"),!1):!0}initialise(){document.body.addEventListener("htmx:configRequest",n=>{this.configRequest(n)});document.body.addEventListener("htmx:beforeRequest",n=>{this.beforeRequest(n)});document.body.addEventListener("htmx:confirm",n=>{this.confirmRequest(n)});document.body.addEventListener("htmx:afterSettle",n=>{this.afterSettle(n)});this.invokeEventHandler("Initialised")}transformText(n){n.addEventListener("input",n=>{n.preventDefault();let t=n.target;t.value=t.dataset.texttransform=="Uppercase"?t.value.toUpperCase():t.value.toLowerCase()})}updateLinkedChildControls(n){this.formContainer.dataset.linkedcontrolids&&this.updateLinkedControls(this.formContainer.dataset.linkedcontrolids,n)}makeSelectReadonly(n){"change".split(" ").forEach(function(t){n.addEventListener(t,t=>{t.preventDefault(),n.value=n.dataset.value})})}makeCheckboxReadonly(n){"click".split(" ").forEach(function(t){n.addEventListener(t,t=>{t.preventDefault(),n.checked=JSON.parse(n.dataset.value)})})}confirmRequest(n){if(this.isControlEvent(n)!=!1&&n.target.hasAttribute("hx-confirm-dialog")!=!1){if(n.preventDefault(),!this.confirmDialog){let t=n.target.getAttribute("hx-confirm-dialog");this.confirmDialog=new ConfirmDialog(this,t)}(n.srcElement.name!="delete"||this.validateDelete())&&this.confirmDialog.open(n,this.formBody)}}configRequest(n){this.isControlEvent(n)!=!1&&(this.htmlEditorElements().forEach(t=>{this.htmlEditorArray[t.id].assignContent(n)}),this.controlElements(".fc-control").forEach(t=>{this.elementModified(t)==!1?delete n.detail.parameters[t.name]:n.detail.parameters[t.name]==undefined&&(n.detail.parameters[t.name]="")}))}beforeRequest(n){if(this.isControlEvent(n)!=!1){switch(this.triggerName(n)){case"apply":this.formModified()==!1?n.preventDefault():this.form.checkValidity()==!1&&(this.form.reportValidity(),n.preventDefault());return;case"cancel":case"primarykey":return}if(this.formMode()!="empty"){this.controlElements(".fc-control").forEach(n=>{n.dataset.modified=this.elementModified(n)});let t=this.controlElements(".fc-control[data-modified='true']");t.length&&(n.preventDefault(),this.setMessage(this.formBody.dataset.unappliedmessage,"warning"))}}}configureHtmlEditor(n,t){this.invokeEventHandler("ConfigureHtmlEditor",{configuration:n,columnName:t})}formControlValue(n){return this.elementValue(n,!1)}formControlDbValue(n){return this.elementValue(n,!0)}elementValue(n,t){var i=this.formControl(n);if(i)return i.tagName=="INPUT"&&i.type=="checkbox"?t?this.isBoolean(i.dataset.value):i.checked:t?i.dataset.value:i.value;console.error(`Form control for column name ${n} not found`)}highlightError(n){var t=this.formControl(n);t.dataset.error="true"}errorHighlighted(){let n=Array.from(this.controlElements(".fc-control")).filter(n=>n.dataset.error=="true").length;return n>0}setFocus(){var n=this.errorHighlighted()?".fc-control[data-error='true']":".fc-control";for(const t of this.controlElements(n))if(t.readOnly==!1&&t.disabled==!1){t.focus();break}}formControl(n){var t;return this.controlElements(".fc-control").forEach(i=>{i.name.toLowerCase()==`_${n.toLowerCase()}`&&(t=i)}),t}formModified(){if(this.formMode()=="empty")return!1;let n=[];return this.controlElements(".fc-control").forEach(t=>{this.elementModified(t)&&n.push(t)}),n.length>0}elementModified(n){if(n.tagName=="INPUT"&&n.type=="checkbox")return this.isBoolean(n.dataset.value)!=n.checked;if(n.type=="select-multiple"){var t=Array.from(n.selectedOptions).map(({value:n})=>n);return(n.dataset.dbdatatype="Array")?this.cleanString(n.dataset.value)!=this.cleanString(t.join("")):n.dataset.value!=t.join(",")}return n.tagName=="TEXTAREA"?this.cleanString(n.dataset.value)!=this.cleanString(n.value):n.dataset.value!=n.value}cleanString(n){return n.replace("&amp;#xA;","").replace(/[^a-z0-9\.]+/gi,"").trim()}isBoolean(n){return n=="1"||n.toLowerCase()=="true"}setMessage(n,t="success"){this.formMessage.innerText=n;this.formMessage.dataset.highlight=t.toLowerCase();window.setTimeout(()=>{this.clearErrorMessage()},3e3)}clearErrorMessage(){this.formMessage.innerHTML="&nbsp";delete this.formMessage.dataset.highlight;this.controlElements(`.fc-control`).forEach(n=>{n.dataset.modified=!1,n.dataset.error=!1})}htmlEditorElements(){return this.controlElements("textarea[data-htmleditor]")}configureHtmlEditors(){let n=this.htmlEditorElements();if(n.length!=0){let t=n[0].dataset.htmleditor;if(!HtmlEditor.editor(t)){this.setMessage(`${t} library not available.`,"error");this.htmlEditorElements().forEach(n=>{HtmlEditor.removeElement(n),n.classList.remove("hidden"),n.removeAttribute("data-htmleditor")});this.htmlEditorMissing=!0;return}window.setTimeout(()=>{this.initHtmlEditor()},1)}}initHtmlEditor(){this.htmlEditorElements().forEach(n=>{this.htmlEditorArray[n.id]=new HtmlEditor(n,this)})}}class DraggableDialog{constructor(n,t="dialog-header",i){if(this.isDragging=!1,this.initialX=0,this.initialY=0,this.xOffset=0,this.yOffset=0,this.dialog=document.getElementById(n),this.container=i,!this.dialog)throw new Error(`Dialog with id "${n}" not found`);if(this.dragHandle=this.dialog.querySelector(`.${t}`),!this.dragHandle)throw new Error(`Drag handle with class "${t}" not found in the dialog`);const r=new ResizeObserver(n=>{for(let t of n)this.ensureDialogInViewport()});r.observe(this.container);this.initDragEvents()}initDragEvents(){this.dragHandle.addEventListener("mousedown",this.startDragging.bind(this));document.addEventListener("mousemove",this.drag.bind(this));document.addEventListener("mouseup",this.stopDragging.bind(this));let n=this.dialog.getBoundingClientRect().left-this.container.getBoundingClientRect().left,t=this.dialog.getBoundingClientRect().top-this.container.getBoundingClientRect().top;this.xOffset=0-this.container.clientWidth/2+this.container.offsetLeft+n;this.yOffset=0-this.container.clientHeight/2+this.container.offsetTop+t;this.setTranslate(this.xOffset,this.yOffset)}startDragging(n){n.target.closest(`.${this.dragHandle.className}`)===this.dragHandle&&(this.isDragging=!0,this.initialX=n.clientX-(this.xOffset?this.xOffset:this.dialog.clientWidth/-2),this.initialY=n.clientY-(this.yOffset?this.yOffset:this.dialog.clientHeight/-2),this.dragHandle.style.cursor="move",document.body.style.userSelect="none")}drag(n){this.isDragging&&(n.preventDefault(),this.xOffset=n.clientX-this.initialX,this.yOffset=n.clientY-this.initialY,this.setTranslate(this.xOffset,this.yOffset))}stopDragging(){this.isDragging=!1;this.dragHandle.style.cursor="";document.body.style.userSelect="";document.removeEventListener("mousemove",this.drag);document.removeEventListener("mouseup",this.stopDragging)}setTranslate(n,t){requestAnimationFrame(()=>{this.dialog.style.transform=`translate3d(${n}px, ${t}px, 0)`})}ensureDialogInViewport(){const i={width:window.innerWidth,height:window.innerHeight},n=this.dialog.getBoundingClientRect(),r=this.container.getBoundingClientRect(),t={x:0,y:0};n.left<r.left&&(t.x=r.left-n.left);n.top<r.top&&(t.y=r.top-n.top);n.right>i.width&&(t.x=i.width-n.right);n.bottom>i.height&&(t.y=i.height-n.bottom);this.xOffset=t.x!=0?t.x:this.xOffset;this.yOffset=t.y!=0?t.y:this.yOffset;this.setTranslate(this.xOffset,this.yOffset)}}class Dialog{constructor(n,t){this.draggableDialog=null;this.dialog=n;this.dialog.style.margin="0";this.dialog.style.position="absolute";this.control=t;this.container=t.controlContainer;let i=this.dialog.querySelectorAll(this.control.buttonSelector("close"));i.forEach(n=>{n.addEventListener("click",()=>this.close())})}show(n=true,t=false){t?this.dialog.showModal():this.dialog.show();this.container.style.position="relative";this.dialog.style.transform==""&&(this.dialog.style.transform=`translate(-50%, -50%)`,this.dialog.style.left="50%",this.dialog.style.top="50%");n&&!this.draggableDialog&&(this.draggableDialog=new DraggableDialog(this.dialog.id,"dialog-nav",this.container))}close(){this.dependentDialog&&this.dependentDialog.close();this.dialog&&this.dialog.open&&this.dialog.close()}}class ViewDialog extends Dialog{constructor(n,t){super(n,t);this.gridControl=t;this.dialog.querySelector(this.control.buttonSelector("previous")).addEventListener("click",()=>t.previousRow());this.dialog.querySelector(this.control.buttonSelector("next")).addEventListener("click",()=>t.nextRow());this.control.getButton("view").addEventListener("click",this.open.bind(this))}open(){this.getRecord()}update(){this.dialog&&this.dialog.open&&this.getRecord()}getRecord(){let n=this.dialog.querySelector("input[hx-post]");n.value=this.gridControl.selectedRow.dataset.id;htmx.trigger(n,"changed")}configureNavigation(n){this.configureButton(n.previousElementSibling,"previous");this.configureButton(n.nextElementSibling,"next")}configureButton(n,t){this.dialog.querySelector(this.gridControl.buttonSelector(t)).disabled=!n||n.classList.contains("grid-row")==!1}columnCell(n){return this.dialog.querySelector(`div[data-columnname='${n.toLowerCase()}']`)}columnValue(n){let t=this.columnCell(n);return t?t.dataset.value:null}}class ConfirmDialog extends Dialog{constructor(n,t){super(n.controlElement(".confirm-dialog"),n);this.dialog.querySelector(".prompt").innerHTML=t;this.dialog.querySelector(this.control.buttonSelector("confirm")).addEventListener("click",()=>this.confirm());this.dialog.querySelector(this.control.buttonSelector("cancel")).addEventListener("click",()=>this.cancel())}open(n){this.event=n;this.show(!1,!0)}confirm(){this.event.detail.issueRequest(!0);this.dialog.close()}cancel(){this.dialog.close()}}class HtmlEditor{constructor(n,t){this.textarea=n;this.formControl=t;this.initialise()}reset(n){switch(HtmlEditor.editorName(n)){case HtmlEditor.TinyMCE:HtmlEditor.editor("tinymce").remove(`#${n.id}`);break;case HtmlEditor.CKEditor:this.editorInstance.destroy()}}initialise(){switch(HtmlEditor.editorName(this.textarea)){case HtmlEditor.TinyMCE:this.initTinyMceEditor();break;case HtmlEditor.CKEditor:this.initCKEditorEditor();break;case HtmlEditor.Froala:this.initFroalaEditor()}}assignContent(n){switch(HtmlEditor.editorName(this.textarea)){case HtmlEditor.TinyMCE:this.textarea.value=HtmlEditor.editor("tinymce").get(this.textarea.id).getContent();n.detail.parameters[this.textarea.name]=this.textarea.value;break;case HtmlEditor.CKEditor:this.textarea.value=this.editorInstance.getData();n.detail.parameters[this.textarea.name]=this.textarea.value;break;case HtmlEditor.Froala:this.textarea.value=this.editorInstance.html.get(!0);n.detail.parameters[this.textarea.name]=this.textarea.value}}initTinyMceEditor(){var n={selector:`#${this.textarea.id}`,license_key:"gpl"};this.updateConfiguration(n);HtmlEditor.editor("tinymce").init(n)}updateConfiguration(n){this.formControl.configureHtmlEditor(n,this.textarea.name.substring(1))}initCKEditorEditor(){const{ClassicEditor:t,Essentials:i,Bold:r,Italic:u,Font:f,Paragraph:e}=window.CKEDITOR;let n={licenseKey:"",plugins:[i,r,u,f,e],toolbar:["undo","redo","|","bold","italic","|","fontSize","fontFamily","fontColor","fontBackgroundColor"]};this.updateConfiguration(n);t.create(document.querySelector(`#${this.textarea.id}_ckeditor`),n).then(n=>{this.editorInstance=n})}initFroalaEditor(){this.editorInstance=new window.FroalaEditor(`#${this.textarea.id}_froala`)}static editorName(n){return n.dataset.htmleditor}static removeElement(n){switch(HtmlEditor.editorName(n)){case HtmlEditor.Froala:case HtmlEditor.CKEditor:document.querySelector(`#${n.id}_${HtmlEditor.editorName(n).toLowerCase()}`).remove()}}static editor(n){switch(n){case HtmlEditor.TinyMCE:n=n.toLowerCase();break;case HtmlEditor.Froala:n="FroalaEditor";break;case HtmlEditor.CKEditor:n="CKEDITOR"}return window[n]}}HtmlEditor.TinyMCE="TinyMCE";HtmlEditor.CKEditor="CKEditor";HtmlEditor.Froala="Froala";class SearchDialog extends Dialog{constructor(n,t){super(n,t);this.lookupDialog=new LookupDialog(t.controlElement(".lookup-dialog"),t);this.dependentDialog=this.lookupDialog;this.control.getButton("search").addEventListener("click",this.show.bind(this));this.control.getButton("clear").addEventListener("click",this.clear.bind(this));n.querySelectorAll(".search-operator").forEach(n=>n.addEventListener("change",n=>this.operatorSelected(n)));n.querySelectorAll("input").forEach(n=>"input,change".split(",").forEach(t=>n.addEventListener(t,this.valueEntered.bind({event:n}))));n.querySelectorAll("button[button-type='list']").forEach(n=>n.addEventListener("click",n=>this.showLookup(n)))}operatorSelected(n){let i=n.target,t=i.closest("tr");t.querySelectorAll(".first").forEach(n=>n.classList.remove("hidden"));switch(i.value){case"Between":case"NotBetween":t.querySelectorAll(".between").forEach(n=>n.classList.remove("hidden"));break;case"IsEmpty":case"IsNotEmpty":t.querySelectorAll(".between").forEach(n=>n.classList.add("hidden"));t.querySelectorAll(".first").forEach(n=>n.classList.add("hidden"));break;default:t.querySelectorAll(".between").forEach(n=>n.classList.add("hidden"))}t.querySelectorAll("input").forEach(n=>{n.type!="hidden"&&(n.required=!1)});i.value==""?t.querySelectorAll("input").forEach(n=>{n.type!="hidden"&&(n.value="")}):t.querySelectorAll("input").forEach(n=>{this.isVisible(n)&&(n.required=!0)})}isVisible(n){return!!(n.offsetWidth||n.offsetHeight||n.getClientRects().length)}valueEntered(n){let t=n.target,r=t.closest("tr"),i=r.querySelector("select");t.value!=""&&i.value==""?i.options[1].selected=!0:t.value==""&&(i.value="")}showLookup(n){let t=n.target.closest("button"),i=t.closest("tr").querySelector("input"),r=this.dialog.querySelector(`select[data-key='${t.dataset.key}']`);this.lookupDialog.open(r,i)}clear(){this.dialog.querySelectorAll(".search-operator").forEach(n=>{n.value="",n.dispatchEvent(new Event("change"))})}}class LookupDialog extends Dialog{constructor(n,t){super(n,t);this.select=n.querySelector("select");this.control.getButton("cancel").addEventListener("click",()=>this.close());this.control.getButton("select").addEventListener("click",()=>this.apply())}open(n,t){this.select.innerHTML=n.innerHTML;var i=t.value.split(",");i.forEach(n=>{const t=this.select.options;for(let i=0;i<t.length;i++)t[i].value===n&&(t[i].selected=!0)});this.input=t;this.show();this.select.focus()}apply(){var n=Array.from(this.select.selectedOptions).map(({value:n})=>n);this.input.value=n.join(",");this.input.dispatchEvent(new Event("change"));this.close()}}