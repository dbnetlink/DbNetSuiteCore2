@model DbNetSuiteCore.ViewModels.GridViewModel
@using System.Data
@using DbNetSuiteCore.Helpers
@using DbNetSuiteCore.Models
@using DbNetSuiteCore.ViewModels
@using Microsoft.AspNetCore.Html
@using DbNetSuiteCore.Constants
@using DbNetSuiteCore.Enums

<div class="grid-container flex flex-col gap-2">
    @if (string.IsNullOrEmpty(Model.GridModel.Caption) == false)
    {
        <div class="flex text-lg caption">@Model.GridModel.Caption</div>
    }
    @if (Model.GridModel.ToolbarPosition == ToolbarPosition.Top)
    {
        @await Html.PartialAsync("Grid/__Toolbar", Model)
        @if (Model.IsEditable)
        {
            <div id="form-message" class="border rounded border-slate-300 p-1">&nbsp;</div>
        }
    }
    <div class="flex">
        <table class="table-auto border-collapse grid-table" data-linkedgridids="@Model.LinkedGridIds" data-linkedcontrolids="@Model.LinkedControlIds">
            <colgroup>
                @if (Model.GridModel.MultiRowSelectLocation == MultiRowSelectLocation.Left)
                {
                    <col />
                }
                @if (Model.HasNestedGrids)
                {
                    <col />
                }
                @foreach (GridColumnViewModel gridColumn in Model.VisibleColumns)
                {
                    if (Model.GetDataColumn(gridColumn.Column) != null)
                    {
                        <col data-datatype="@gridColumn.DataTypeName" data-dbdatatype="@gridColumn.DbDataType" data-userdatatype="@gridColumn.UserDataType" style="visibility:@(gridColumn.Column.Visible ? "visible" : "collapse")" />
                    }
                }
                @if (Model.GridModel.MultiRowSelectLocation == MultiRowSelectLocation.Right)
                {
                    <col />
                }
            </colgroup>

            <thead data-frozen="@(Model.GridModel.HeadingMode == HeadingMode.Frozen)" data-rowselection="@Model.GridModel.RowSelection">
                <tr class="bg-slate-200 heading-row" style="display:@(Model.GridModel.HeadingMode == HeadingMode.Hidden ? "none" : string.Empty)">
                    @if (Model.GridModel.MultiRowSelectLocation == MultiRowSelectLocation.Left)
                    {
                        <th class="text-base"><input class="multi-select" type="checkbox" /></th>
                    }
                    @if (Model.HasNestedGrids)
                    {
                        <th class="text-base w-12"></th>
                    }
                    @foreach (GridColumnViewModel gridColumn in Model.VisibleColumns)
                    {
                        if (Model.GetDataColumn(gridColumn.Column) == null)
                        {
                            continue;
                        }
                        if (gridColumn.Sortable)
                        {
                            <th class="text-base" style="cursor:pointer" data-key="@gridColumn.Key" data-columnname="@Model.ObfuscateColumnName(gridColumn.Column)" hx-vals='{"sortKey":"@gridColumn.Key"}' hx-post="@Model.SubmitUrl" hx-target="next tbody" hx-swap="outerHTML" hx-indicator="next .htmx-indicator">
                                <div class="flex flex-row justify-between items-center">@gridColumn.Column.Label<span class="text-slate-400"></span></div>
                            </th>
                        }
                        else
                        {
                            <th class="text-base">@gridColumn.Column.Label</th>
                        }
                    }
                    @if (Model.GridModel.MultiRowSelectLocation == MultiRowSelectLocation.Right)
                    {
                        <th class="text-base"><input class="multi-select" type="checkbox" /></th>
                    }
                </tr>

                @if (Model.FilterColumns.Any())
                {
                    <tr class="filter-row">
                        @if (Model.GridModel.MultiRowSelectLocation == MultiRowSelectLocation.Left)
                        {
                            <th class="text-base"></th>
                        }
                        @if (Model.HasNestedGrids)
                        {
                            <th class="text-base w-12"></th>
                        }
                        @foreach (GridColumnViewModel gridColumn in Model.VisibleColumns)
                        {
                            var classes = new List<string>() { "text-base" };
                            classes.Add(gridColumn.AlignmentClassName());

                            if (Model.GetDataColumn(gridColumn.Column) != null)
                            {
                                <th @RazorHelper.CellDataAttributes(classes, string.Empty, string.Empty)>@Model.RenderColumnFilter(gridColumn.Column)</th>
                            }
                        }
                        @if (Model.GridModel.MultiRowSelectLocation == MultiRowSelectLocation.Right)
                        {
                            <th class="text-base"></th>
                        }
                    </tr>
                }
            </thead>
            @await Html.PartialAsync("Grid/__Rows", Model)
        </table>
    </div>
    @if (Model.GridModel.ToolbarPosition == ToolbarPosition.Bottom)
    {
        @await Html.PartialAsync("Grid/__Toolbar", Model)
    }
    <div class="flex">
        @await Html.PartialAsync("__HxIndicator")
    </div>
    @await Html.PartialAsync("__ToastMessage")
    @if (Model.GridModel.ViewDialog != null)
    {
        @await Html.PartialAsync("Grid/__ViewDialog", Model)
    }
    @if (Model.SearchDialog)
    {
        @await Html.PartialAsync("Shared/__SearchDialog", Model)
    }
</div>